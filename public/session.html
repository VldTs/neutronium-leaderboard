<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Session - Neutronium Leaderboard</title>
  <meta name="description" content="Active game session for Neutronium Expansion">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0a0e17">
</head>
<body class="session-page">
  <header class="header">
    <div class="container header-content">
      <a href="/" class="logo">
        <div class="logo-icon"></div>
        <span>Neutronium</span>
      </a>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/leaderboard.html">Leaderboard</a>
        <a href="/profile.html">Profile</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Session Header -->
    <section id="session-header" class="session-header-redesign mt-lg">
      <div class="session-level-display">Level <span id="session-level">-</span></div>
      <div class="session-meta-line">
        <span>Box: <span id="session-box">-</span></span>
        <span id="session-status" class="badge badge-host">Active</span>
        <span id="session-player-count"></span>
      </div>
    </section>

    <!-- Loading State -->
    <div id="session-loading" class="loading mt-xl">
      <div class="spinner"></div>
    </div>

    <!-- Session Not Found -->
    <div id="session-not-found" class="card mt-lg hidden">
      <div class="text-center">
        <h3 class="mb-md">Session Not Found</h3>
        <p class="text-muted mb-lg">This session may have ended or the link is invalid.</p>
        <a href="/" class="btn btn-primary">Go Home</a>
      </div>
    </div>

    <!-- Session Content -->
    <div id="session-content" class="hidden">
      <!-- Guest Sign In Banner (shown for guests) -->
      <div id="guest-signin-banner" class="card mt-lg hidden" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); border-color: var(--color-accent);">
        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <h4 style="margin: 0 0 0.25rem 0;">Playing as Guest</h4>
            <p class="text-muted" style="margin: 0; font-size: 0.875rem;">Sign in to unlock higher levels and save your progress</p>
          </div>
          <button type="button" id="btn-session-signin" class="btn btn-primary">
            <span>Sign In</span>
            <span class="btn-icon">&#8594;</span>
          </button>
        </div>
      </div>

      <!-- Level Changed Banner (shown when level was adjusted) -->
      <div id="level-changed-banner" class="card mt-lg hidden" style="background: rgba(245, 158, 11, 0.1); border-color: #f59e0b;">
        <div class="alert alert-warning" style="margin: 0; padding: 0; background: none; border: none;">
          <span class="alert-icon">&#128276;</span>
          <div>
            <strong>Level Adjusted</strong>
            <p id="level-changed-message" style="margin: 0;">The session level was adjusted to match all players' progress.</p>
          </div>
        </div>
      </div>

      <!-- Players List -->
      <section class="card mt-lg">
        <h3 class="card-title mb-md">Players</h3>
        <div id="players-list">
          <!-- Player cards will be inserted here -->
        </div>
      </section>

      <!-- Your Score Input (if in session) -->
      <div id="score-input" class="score-input-sticky mt-lg">
        <section class="card">
          <div class="score-header mb-md">
            <h3 class="card-title">Your Score</h3>
            <div id="my-color-indicator" class="my-color-indicator"></div>
          </div>
          <input type="hidden" id="my-color" value="">
          <div id="reference-scores" class="reference-scores hidden">
            <!-- Filled by JS -->
          </div>
          <div class="score-grid">
            <div class="form-group">
              <label class="form-label">Starting Nn</label>
              <div id="my-starting-nn" class="score-display" data-value="0">
                <span class="score-display-value">â€”</span>
              </div>
              <span id="starting-nn-hint" class="form-hint hidden"></span>
            </div>
            <div class="form-group">
              <label class="form-label" for="my-final-nn">Final Nn</label>
              <input type="number" id="my-final-nn" class="score-input-lg score-input-final" inputmode="numeric" pattern="[0-9]*" min="0" placeholder="0">
            </div>
          </div>
          <button type="button" id="btn-submit-score" class="btn btn-primary btn-lg" style="width: 100%;">
            Submit Score
          </button>
          <p id="score-submitted-msg" class="text-center text-muted mt-md hidden">
            Score submitted! You can update it anytime before the game ends.
          </p>
        </section>
      </div>

      <!-- End Game Section -->
      <section class="card mt-lg">
        <div class="end-game-section">
          <div class="end-game-info">
            <h3 class="card-title">End Game</h3>
            <div id="vote-dots" class="vote-dots">
              <!-- Vote dots rendered by JS -->
            </div>
          </div>
          <button type="button" id="btn-end-game" class="btn btn-secondary btn-lg">
            Vote to End
          </button>
        </div>
        <span id="end-votes" class="hidden">0/0</span>
      </section>
    </div>

    <!-- Sign In Modal -->
    <div id="signin-modal" class="modal-overlay">
      <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
          <h3 class="modal-title">Sign In</h3>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-lg">Enter your email to receive a magic link. After signing in, you'll return to this session with your unlocked levels.</p>
          <div class="form-group">
            <label class="form-label" for="signin-email">
              <span class="form-label-icon">&#9993;</span>
              Email
            </label>
            <input type="email" id="signin-email" class="form-input" placeholder="your@email.com">
          </div>
          <div id="signin-success" class="alert alert-success hidden">
            <span class="alert-icon">&#10003;</span>
            <div>
              <strong>Check your email!</strong>
              <p>Click the magic link to sign in. You'll be redirected back to this session.</p>
            </div>
          </div>
        </div>
        <div class="mt-lg" style="display: flex; gap: 1rem;">
          <button type="button" id="btn-cancel-signin" class="btn btn-secondary" style="flex: 1;">Cancel</button>
          <button type="button" id="btn-send-signin-link" class="btn btn-primary" style="flex: 1;">Send Magic Link</button>
        </div>
      </div>
    </div>

    <!-- Results Modal -->
    <div id="results-modal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Game Complete!</h3>
        </div>
        <div id="results-content">
          <!-- Results will be inserted here -->
        </div>
        <div class="mt-lg" style="display: flex; gap: 1rem;">
          <a href="/leaderboard.html" class="btn btn-secondary" style="flex: 1;">View Leaderboard</a>
          <a href="/" class="btn btn-primary" style="flex: 1;">New Game</a>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <a href="https://neutronium.games" target="_blank" rel="noopener" class="footer-brand">neutronium.games</a>
      <p>Neutronium Expansion &copy; 2026</p>
    </div>
  </footer>

  <script src="/js/auth.js"></script>
  <script src="/js/session.js"></script>
</body>
</html>